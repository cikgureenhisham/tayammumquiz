<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>أديك تيمم - Pro Edition V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Amiri', serif; overflow: hidden; touch-action: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border-radius: 20px; }
    </style>
</head>
<body>

<script>
let video;
let faceMesh;
let faces = [];
let gameState = "START"; 
let currentQ = 0;
let score = 0;
let feedback = "";
let particles = [];

const quiz = [
    { q: "اڤاكه مقصود تيمم؟", a: "ساڤو دبو كـموك دان تاڠن", b: "باسوه مـوك دڠن اءير", ans: "left" },
    { q: "سبب دشرطكن تيمم؟", a: "مالس امبيل وضوء", b: "كتياداءن اءير / ساكيت", ans: "right" },
    { q: "ماناكه روكون تيمم؟", a: "نية دان مپاڤو دبو", b: "ممباسوه تليڠا", ans: "left" },
    { q: "ڤركارا سنة تيمم؟", a: "مڠهادڤ قبلة", b: "مپاڤو كاكي", ans: "left" },
    { q: "مپاڤو دبو كتاڠن هيڠݢ...", a: "باهو", b: "سيكو", ans: "right" }
];

function preload() {
    // Muat turun model AI
    faceMesh = ml5.faceMesh({ maxFaces: 1, flipped: true });
}

function setup() {
    // Tetapkan saiz kanvas 9:16
    let h = windowHeight * 0.95;
    let w = (h * 9) / 16;
    if (w > windowWidth) {
        w = windowWidth * 0.9;
        h = (w * 16) / 9;
    }
    createCanvas(w, h);
    
    // AKSES KAMERA (Cara paling stabil)
    let constraints = {
        video: {
            facingMode: "user",
            width: 640,
            height: 480
        },
        audio: false
    };

    video = createCapture(VIDEO, constraints, function(stream) {
        console.log("Kamera aktif!");
    });
    video.size(640, 480);
    video.hide();

    // Mula kesan muka
    faceMesh.detectStart(video, (results) => {
        faces = results;
    });

    shuffle(quiz, true);
    textAlign(CENTER, CENTER);
}

function draw() {
    background(0);
    
    if (video) {
        // LOGIK ANTI-LEPER (Center Crop)
        let vRatio = video.width / video.height;
        let cRatio = width / height;
        let sw, sh, sx, sy;

        if (vRatio > cRatio) {
            sh = video.height;
            sw = sh * cRatio;
            sx = (video.width - sw) / 2;
            sy = 0;
        } else {
            sw = video.width;
            sh = sw / cRatio;
            sx = 0;
            sy = (video.height - sh) / 2;
        }
        image(video, 0, 0, width, height, sx, sy, sw, sh);
    }

    if (gameState === "START") drawStart();
    else if (gameState === "PLAY") drawPlay();
    else if (gameState === "END") drawEnd();

    // Animasi Partikel
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].show();
        if (particles[i].finished()) particles.splice(i, 1);
    }
}

function drawStart() {
    fill(0, 150);
    rect(0, 0, width, height);
    fill("#FFD700");
    textSize(width * 0.12);
    text("أديق تيمم", width/2, height/2 - 20);
    fill(255);
    textSize(width * 0.05);
    text("كليق سكرين اونتوق مـولا", width/2, height/2 + 40);
}

function drawPlay() {
    let data = quiz[currentQ];
    
    // UI Soalan
    fill(255, 240);
    noStroke();
    rect(width*0.05, height*0.1, width*0.9, height*0.15, 15);
    fill(0);
    textSize(width * 0.06);
    text(data.q, width/2, height*0.17);

    // Jawapan
    drawIGBox(width*0.05, height*0.75, data.a, "#E1306C");
    drawIGBox(width*0.52, height*0.75, data.b, "#405DE6");

    // Pointer Bintang
    if (faces.length > 0) {
        let nose = faces[0].keypoints[1];
        
        let vRatio = video.width / video.height;
        let cRatio = width / height;
        let sw = video.height * cRatio;
        let sx = (video.width - sw) / 2;
        
        let nx = map(nose.x, sx, sx + sw, 0, width);
        let ny = map(nose.y, 0, video.height, 0, height);
        
        fill(255, 235, 59);
        textSize(width * 0.1);
        text("⭐", nx, ny);
        
        // ANTI-SENSITIF: Kena gerak jauh ke tepi
        if (nx < width * 0.2) checkAns("left");
        if (nx > width * 0.8) checkAns("right");
    }
    
    if (feedback !== "") {
        fill(255);
        textSize(width * 0.3);
        text(feedback, width/2, height/2);
    }
}

function drawIGBox(x, y, txt, col) {
    fill(col);
    rect(x, y, width*0.43, height*0.15, 15);
    fill(255);
    textSize(width * 0.045);
    textWrap(WORD);
    text(txt, x + 5, y + 5, width*0.38, height*0.13);
}

function checkAns(side) {
    if (feedback !== "") return;
    if (side === quiz[currentQ].ans) {
        score++;
        feedback = "✅";
        for(let i=0; i<15; i++) particles.push(new Particle(width/2, height/2, "#4caf50"));
    } else {
        feedback = "❌";
    }
    setTimeout(() => {
        feedback = "";
        currentQ++;
        if (currentQ >= quiz.length) gameState = "END";
    }, 1200);
}

function drawEnd() {
    fill(0, 200);
    rect(0,0,width,height);
    fill("#FFD700");
    textSize(width * 0.15);
    text("تـمـت!", width/2, height/2 - 20);
    fill(255);
    textSize(width * 0.06);
    text("سكور: " + score, width/2, height/2 + 40);
}

function mousePressed() {
    if (gameState !== "PLAY") {
        shuffle(quiz, true);
        currentQ = 0; score = 0; gameState = "PLAY";
    }
}

class Particle {
    constructor(x, y, col) {
        this.x = x; this.y = y;
        this.vx = random(-3, 3); this.vy = random(-3, 3);
        this.alpha = 255; this.col = col;
    }
    finished() { return this.alpha < 0; }
    update() { this.x += this.vx; this.y += this.vy; this.alpha -= 10; }
    show() { noStroke(); fill(this.col + hex(floor(this.alpha), 2)); ellipse(this.x, this.y, 8); }
}
</script>
</body>
</html>
