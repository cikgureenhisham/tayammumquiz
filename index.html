<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> تيمم </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; padding: 0; background: #fff9c4; 
            font-family: 'Amiri', serif; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; overflow: hidden; touch-action: none;
        }
        h1 { 
            font-size: 5vw; color: #f57f17; margin: 5px 0; 
            direction: rtl; z-index: 10;
        }
        /* Memastikan Canvas sentiasa muat dalam skrin telefon tanpa leper */
        canvas { 
            max-width: 100%; height: auto !important; 
            border: 5px solid #fff; border-radius: 20px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <h1>✨ تيمم ✨</h1>

<script>
let video;
let faceMesh;
let faces = [];
let gameState = "START"; 
let currentQ = 0;
let score = 0;
let feedback = "";
let feedbackColor;

const quiz = [
    { q: "اڤاكه مقصود تيمم؟", a: "ساڤو دبو كـموك دان تاڠن", b: "باسوه مـوك دڠن اءير", ans: "left" },
    { q: "سبب دشرطكن تيمم؟", a: "مالس امبيل وضوء", b: "كتياداءن اءير / ساكيت", ans: "right" },
    { q: "ماناكه روكون تيمم؟", a: "نية دان مپاڤو دبو", b: "ممباسوه تليڠا", ans: "left" },
    { q: "ڤركارا سنة تيمم؟", a: "مڠهادڤ قبلة", b: "مپاڤو كاكي", ans: "left" },
    { q: "مپاڤو دبو كتاڠن هيڠݢ...", a: "باهو", b: "سيكو", ans: "right" }
];

function preload() {
    faceMesh = ml5.faceMesh({ maxFaces: 1, flipped: true });
}

function setup() {
    // Tetapkan saiz kanvas yang responsif
    let canvas = createCanvas(640, 480);
    
    // Konfigurasi kamera yang lebih stabil
    let constraints = {
        video: {
            mandatory: {
                minWidth: 640,
                minHeight: 480
            },
            optional: [{ facingMode: "user" }]
        },
        audio: false
    };

    // Mulakan rakaman video
    video = createCapture(VIDEO, constraints, function(stream) {
        console.log("Kamera Berjaya Diakses!");
    });
    
    video.size(640, 480);
    video.hide();

    // Mulakan pengesan muka
    faceMesh.detectStart(video, (results) => {
        faces = results;
    });
    
    textAlign(CENTER, CENTER);
}
// Fungsi untuk resize jika skrin berpusing (rotate)
function windowResized() {
    let canvasWidth = windowWidth < 640 ? windowWidth * 0.95 : 640;
    let canvasHeight = (canvasWidth / 4) * 3;
    resizeCanvas(canvasWidth, canvasHeight);
}

function draw() {
    // Papar video penuh pada canvas
    image(video, 0, 0, width, height);
    background(255, 255, 255, 160); 

    if (gameState === "START") drawStart();
    else if (gameState === "PLAY") drawPlay();
    else if (gameState === "END") drawEnd();
    
    if (feedback !== "") {
        fill(feedbackColor);
        rect(0, 0, width, height);
        fill(255);
        textSize(width * 0.15);
        text(feedback, width/2, height/2);
    }
}

function drawStart() {
    fill(255, 150, 0, 200);
    rect(0, 0, width, height);
    fill(255);
    textSize(width * 0.1);
    text("تيمم چڤت!", width/2, height/2 - 40);
    textSize(width * 0.04);
    text("ݢرقكن كڤالا ككيري اتاو ككانن", width/2, height/2 + 20);
    text("[ كليق سكرين اونتوق مـولا ]", width/2, height/2 + 80);
}

function drawPlay() {
    let data = quiz[currentQ];
    
    // Kotak Soalan Responsif
    fill(255);
    rect(width*0.05, 10, width*0.9, height*0.2, 15);
    fill(0);
    textSize(width * 0.05);
    text(data.q, width/2, height*0.1);

    // Kotak Jawapan Responsif
    drawBox(width*0.05, height*0.7, data.a, "#ec407a"); 
    drawBox(width*0.55, height*0.7, data.b, "#26a69a"); 

    if (faces.length > 0) {
        let nose = faces[0].keypoints[1];
        // Map koordinat supaya sepadan dengan saiz canvas baru
        let nx = map(nose.x, 0, video.width, 0, width);
        let ny = map(nose.y, 0, video.height, 0, height);
        
        fill(255, 235, 59);
        stroke(255, 152, 0);
        strokeWeight(2);
        ellipse(nx, ny, width*0.08, width*0.08);
        
        if (nx < width * 0.3) checkAns("left");
        if (nx > width * 0.7) checkAns("right");
    }
}

function drawBox(x, y, txt, col) {
    fill(col);
    rect(x, y, width*0.4, height*0.25, 10);
    fill(255);
    textSize(width * 0.035);
    textWrap(WORD);
    text(txt, x + 5, y + 5, width*0.38, height*0.23);
}

function checkAns(side) {
    if (feedback !== "") return;
    if (side === quiz[currentQ].ans) {
        score++;
        feedback = "بتول!";
        feedbackColor = color(76, 175, 80, 200);
    } else {
        feedback = "ساله!";
        feedbackColor = color(244, 67, 54, 200);
    }
    setTimeout(() => {
        feedback = "";
        currentQ++;
        if (currentQ >= quiz.length) gameState = "END";
    }, 1500);
}

function drawEnd() {
    fill(0, 150, 136, 220);
    rect(0, 0, width, height);
    fill(255);
    textSize(width * 0.1);
    text("تـمـت!", width/2, height/2 - 20);
    textSize(width * 0.06);
    text("سكور اندا: " + score + " / " + quiz.length, width/2, height/2 + 40);
}

function mousePressed() {
    if (gameState !== "PLAY") {
        currentQ = 0; score = 0; gameState = "PLAY";
    }
}
</script>
</body>
</html>
