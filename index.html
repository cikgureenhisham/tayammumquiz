<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯ÙŠÙƒ ØªÙŠÙ…Ù… - Jawi Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Lateef&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #fff9c4; font-family: 'Amiri', serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #canvas-container { position: relative; border: 10px solid #fff; border-radius: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        h1 { font-size: 3rem; color: #f57f17; margin: 10px 0; text-shadow: 2px 2px #fff; }
        .jawi-text { direction: rtl; }
    </style>
</head>
<body>

    <h1 class="jawi-text">âœ¨ Ø£Ø¯ÙŠÙ‚ ØªÙŠÙ…Ù… âœ¨</h1>
    <div id="canvas-container"></div>

<script>
let video;
let faceMesh;
let predictions = [];
let gameState = "START"; 
let currentQ = 0;
let score = 0;
let highScore = 0;
let feedback = "";
let feedbackColor;

// Data Soalan dalam Tulisan Jawi
const quiz = [
    { q: "Ø§Ú¤Ø§ÙƒÙ‡ Ù…Ù‚ØµÙˆØ¯ ØªÙŠÙ…Ù…ØŸ", a: "Ø³Ø§Ú¤Ùˆ Ø¯Ø¨Ùˆ ÙƒÙ€Ù…ÙˆÙƒ Ø¯Ø§Ù† ØªØ§Ú Ù†", b: "Ø¨Ø§Ø³ÙˆÙ‡ Ù…Ù€ÙˆÙƒ Ø¯Ú Ù† Ø§Ø¡ÙŠØ±", ans: "left" },
    { q: "Ø³Ø¨Ø¨ Ø¯Ø¯Ø´Ø±Ø·ÙƒÙ† ØªÙŠÙ…Ù…ØŸ", a: "Ù…Ø§Ù„Ø³ Ø§Ù…Ø¨ÙŠÙ„ ÙˆØ¶ÙˆØ¡", b: "ÙƒØªÙŠØ§Ø¯Ø§Ø¡Ù† Ø§Ø¡ÙŠØ± / Ø³Ø§ÙƒÙŠØª", ans: "right" },
    { q: "Ù…Ø§Ù†Ø§ÙƒÙ‡ Ø±ÙˆÙƒÙˆÙ† ØªÙŠÙ…Ù…ØŸ", a: "Ù†ÙŠØ© Ø¯Ø§Ù† Ù…Ù¾Ø§Ú¤Ùˆ Ø¯Ø¨Ùˆ", b: "Ù…Ù…Ø¨Ø§Ø³ÙˆÙ‡ ØªÙ„ÙŠÚ Ø§", ans: "left" },
    { q: "Ú¤Ø±ÙƒØ§Ø±Ø§ Ø³Ù†Ø© ØªÙŠÙ…Ù…ØŸ", a: "Ù…Ú Ù‡Ø§Ø¯Ú¤ Ù‚Ø¨Ù„Ø©", b: "Ù…Ù¾Ø§Ú¤Ùˆ ÙƒØ§ÙƒÙŠ", ans: "left" },
    { q: "Ù…Ù¾Ø§Ú¤Ùˆ Ø¯Ø¨Ùˆ ÙƒØªØ§Ú Ù† Ù‡ÙŠÚ Ý¢...", a: "Ø¨Ø§Ù‡Ùˆ", b: "Ø³ÙŠÙƒÙˆ", ans: "right" }
];

function setup() {
    let canvas = createCanvas(640, 480);
    canvas.parent('canvas-container');
    
    video = createCapture(VIDEO);
    video.size(640, 480);
    video.hide();

    // Load High Score dari LocalStorage
    highScore = getItem('highScore') || 0;

    faceMesh = ml5.faceMesh(video, () => console.log("Kamera Jawi Sedia!"));
    faceMesh.on("predict", r => predictions = r);
    
    textAlign(CENTER, CENTER);
}

function draw() {
    // Mirror Video
    push();
    translate(width, 0);
    scale(-1, 1);
    image(video, 0, 0, width, height);
    pop();

    background(255, 255, 255, 120); 

    if (gameState === "START") {
        drawStart();
    } else if (gameState === "PLAY") {
        drawPlay();
    } else if (gameState === "END") {
        drawEnd();
    }
    
    drawFeedback();
}

function drawStart() {
    fill(255, 167, 38, 220);
    rect(0, 0, width, height);
    fill(255);
    textSize(50);
    text("ØªÙŠÙ…Ù… Ú†Ú¤Øª!", width/2, height/2 - 40);
    textSize(25);
    text("Ý¢Ø±Ù‚ÙƒÙ† ÙƒÚ¤Ø§Ù„Ø§ ÙƒÙƒÙŠØ±ÙŠ Ø§ØªØ§Ùˆ ÙƒÙƒØ§Ù†Ù†", width/2, height/2 + 20);
    text("Ø³ÙƒÙˆØ± ØªØ±ØªÙŠÚ Ý¢ÙŠ: " + highScore, width/2, height/2 + 70);
    textSize(18);
    text("[ ÙƒÙ„ÙŠÙ‚ Ø§ÙˆÙ†ØªÙˆÙ‚ Ù…Ù€ÙˆÙ„Ø§ ]", width/2, height/2 + 120);
}

function drawPlay() {
    let data = quiz[currentQ];

    // Kotak Soalan
    fill(255);
    noStroke();
    rect(50, 20, 540, 90, 25);
    fill(51);
    textSize(32);
    text(data.q, width/2, 65);

    // Kotak Jawapan (Kiri & Kanan)
    drawOption(60, 350, "Ø£", data.a, "#ec407a"); // Pink
    drawOption(360, 350, "Ø¨", data.b, "#26a69a"); // Green Teal

    // Status
    fill(0);
    textSize(20);
    text(`Ø³ÙƒÙˆØ±: ${score} | Ø³ÙƒÙˆØ± ØªØ±ØªÙŠÚ Ý¢ÙŠ: ${highScore}`, width/2, 130);

    // AI Tracking
    if (predictions.length > 0) {
        let nose = predictions[0].scaledMesh[1];
        let noseX = map(nose[0], 0, 640, 640, 0);
        
        // Avatar Cute
        fill(255, 235, 59);
        stroke(255, 152, 0);
        strokeWeight(3);
        ellipse(noseX, nose[1], 50, 50);
        fill(0);
        noStroke();
        ellipse(noseX-10, nose[1]-5, 6, 6);
        ellipse(noseX+10, nose[1]-5, 6, 6);
        
        // Logik Pilihan
        if (noseX < 180) handleSelection("left");
        if (noseX > 460) handleSelection("right");
    }
}

function drawOption(x, y, label, txt, col) {
    fill(col);
    rect(x, y, 220, 110, 20);
    fill(255);
    textSize(35);
    text(label, x + 110, y + 30);
    textSize(22);
    text(txt, x + 110, y + 75);
}

function handleSelection(side) {
    if (feedback !== "") return;

    if (side === quiz[currentQ].ans) {
        score++;
        feedback = "Ø¨Ù€ØªÙ€ÙˆÙ„! ðŸŒŸ";
        feedbackColor = color(76, 175, 80, 200);
        playSound(true); // Bunyi Betul
    } else {
        feedback = "ØªÙŠØ¯Ù‚ ØªÚ¤Øª ðŸ’”";
        feedbackColor = color(244, 67, 54, 200);
        playSound(false); // Bunyi Salah
    }

    setTimeout(() => {
        feedback = "";
        currentQ++;
        if (currentQ >= quiz.length) endGame();
    }, 1500);
}

// Fungsi Bunyi (Tanpa perlukan fail mp3 luaran)
function playSound(isCorrect) {
    let osc = new p5.Oscillator('sine');
    if (isCorrect) {
        osc.freq(880); // Tinggi
    } else {
        osc.freq(220); // Rendah
    }
    osc.start();
    osc.amp(0.5, 0.1);
    osc.stop(0.3);
}

function drawFeedback() {
    if (feedback !== "") {
        fill(feedbackColor);
        rect(0, 0, width, height);
        fill(255);
        textSize(70);
        text(feedback, width/2, height/2);
    }
}

function endGame() {
    if (score > highScore) {
        highScore = score;
        storeItem('highScore', highScore);
    }
    gameState = "END";
}

function drawEndScreen() {
    fill(255, 152, 0, 230);
    rect(0, 0, width, height);
    fill(255);
    textSize(50);
    text("ØªÙ€Ù…Ù€Øª!", width/2, height/2 - 50);
    textSize(30);
    text(`Ø³ÙƒÙˆØ± Ø§Ù†Ø¯Ø§: ${score} / ${quiz.length}`, width/2, height/2);
    text(`Ø³ÙƒÙˆØ± ØªØ±ØªÙŠÚ Ý¢ÙŠ: ${highScore}`, width/2, height/2 + 50);
    textSize(20);
    text("[ ÙƒÙ„ÙŠÙ‚ Ø§ÙˆÙ†ØªÙˆÙ‚ Ù…Ø§Ø¡ÙŠÙ† Ø³Ù…ÙˆÙ„Ø§ ]", width/2, height/2 + 110);
}

function drawEnd() {
    drawEndScreen();
}

function mousePressed() {
    if (gameState === "START" || gameState === "END") {
        currentQ = 0;
        score = 0;
        gameState = "PLAY";
        userStartAudio(); // Aktifkan audio pelayar
    }
}
</script>
</body>
</html>
